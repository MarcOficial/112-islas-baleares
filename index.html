<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>112 Islas Baleares</title>

  <!-- Favicon -->
  <link
    rel="icon"
    type="image/png"
    href="https://cdn-icons-png.flaticon.com/512/3588/3588592.png"
  />

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PALETA NUEVA 112 MALLORCA -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            mallorca: {
              bg: "#0A0F1F",          /* Azul noche profundo */
              card: "#111827",        /* Gris azulado mate */
              accent: "#1E3A8A",      /* Azul institucional */
              accent2: "#2563EB",     /* Azul brillante */
              coral: "#F43F5E",       /* Rojo coral */
              amber: "#F59E0B",       /* √Åmbar c√°lido */
              text: "#E5E7EB",        /* Texto principal */
              text2: "#9CA3AF",       /* Texto secundario */
            }
          }
        }
      }
    }
  </script>
</head>

<body class="bg-mallorca-bg text-mallorca-text min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    /* ICONOS NUEVOS (m√°s limpios y profesionales) */
    const IconPhone = () => (
      <svg width="26" height="26" stroke="currentColor" fill="none" strokeWidth="2">
        <path d="M22 16.92v3a2 2 0 0 1-2.2 2 19.8 19.8 0 0 1-8.6-3.1 19.5 19.5 0 0 1-6-6A19.8 19.8 0 0 1 2 4.1 2 2 0 0 1 4 2h3a2 2 0 0 1 2 1.7 13 13 0 0 0 .7 2.8 2 2 0 0 1-.5 2.1L8.1 9.9a16 16 0 0 0 6 6l1.3-1.3a2 2 0 0 1 2.1-.5 13 13 0 0 0 2.8.7A2 2 0 0 1 22 16.9z"/>
      </svg>
    );

    const IconUser = () => (
      <svg width="22" height="22" stroke="currentColor" fill="none" strokeWidth="2">
        <circle cx="12" cy="7" r="4" />
        <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />
      </svg>
    );

    const IconPin = () => (
      <svg width="22" height="22" stroke="currentColor" fill="none" strokeWidth="2">
        <path d="M12 22s-8-6-8-13a8 8 0 0 1 16 0c0 7-8 13-8 13z" />
        <circle cx="12" cy="9" r="3" />
      </svg>
    );

    const IconSend = () => (
      <svg width="22" height="22" stroke="currentColor" fill="none" strokeWidth="2">
        <line x1="22" y1="2" x2="11" y2="13" />
        <polygon points="22 2 15 22 11 13 2 9 22 2" />
      </svg>
    );

    const IconLogin = () => (
      <svg width="24" height="24" stroke="currentColor" fill="none" strokeWidth="2">
        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4" />
        <polyline points="10 17 15 12 10 7" />
        <line x1="15" y1="12" x2="3" y2="12" />
      </svg>
    );

    const IconShield = () => (
      <svg width="26" height="26" stroke="currentColor" fill="none" strokeWidth="2">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
      </svg>
    );

    const IconClock = () => (
      <svg width="22" height="22" stroke="currentColor" fill="none" strokeWidth="2">
        <circle cx="12" cy="12" r="10" />
        <polyline points="12 6 12 12 16 14" />
      </svg>
    );

    /* ESTADO INICIAL */
    function Emergency112() {
      const [formData, setFormData] = useState({
        servicio: "",
        incidente: "",
        tipoIncidente: "",
        numeroPersonas: "",
        estadoCiudadano: "",
        vehiculo: "",
        ciudadanoIC: "",
        documentoIC: "",
        telefonoIC: "",
        edadIC: "",
        grupoSanguineo: "",
        condicionesMedicas: "",
        ubicacion: "",
        ciudadanoOOC: "",
        idDiscordOOC: "",
        notasOOC: "",
        nivel: 10,
      });

      const [isSubmitting, setIsSubmitting] = useState(false);
      const [notification, setNotification] = useState({ show: false, message: "", type: "" });
      const [discordUser, setDiscordUser] = useState(null);
      const [isLoadingUser, setIsLoadingUser] = useState(true);
      const [currentTime, setCurrentTime] = useState(new Date());

      /* SERVICIOS */
      const servicios = [
        { value: "Polic√≠a Local", icon: "üëÆ‚Äç‚ôÄÔ∏è", emoji: "üöì", roleId: "ROLE_ID_POLICIA_LOCAL" },
        { value: "Polic√≠a Nacional", icon: "üëÆ‚Äç‚ôÇÔ∏è", emoji: "üöî", roleId: "1398228126919561216" },
        { value: "Guardia Civil", icon: "üõ°Ô∏è", emoji: "üö®", roleId: "ROLE_ID_GUARDIA_CIVIL" },
        { value: "SAMU 061", icon: "üöë", emoji: "üè•", roleId: "1398274968705568878" },
        { value: "Bomberos", icon: "üöí", emoji: "üî•", roleId: "1398274299151913061" },
        { value: "Conservaci√≥n", icon: "üß∞", emoji: "‚öôÔ∏è", roleId: "ROLE_ID_CONSERVACION" },
      ];

      /* PRIORIDAD */
      const getPrioridad = (n) => {
        if (n <= 5) return { label: "BAJA", icon: "üü¢", colorHex: 0x10b981 };
        if (n <= 10) return { label: "MEDIA", icon: "üü°", colorHex: 0xf59e0b };
        return { label: "ALTA", icon: "üî¥", colorHex: 0xef4444 };
      };

      /* RELOJ */
      useEffect(() => {
        const timer = setInterval(() => setCurrentTime(new Date()), 1000);
        return () => clearInterval(timer);
      }, []);

  
      /* AUTENTICACI√ìN DISCORD */
      useEffect(() => {
        const token = localStorage.getItem("discord_token");
        if (token) {
          fetchDiscordUser(token);
        } else {
          const fragment = new URLSearchParams(window.location.hash.slice(1));
          const accessToken = fragment.get("access_token");
          if (accessToken) {
            localStorage.setItem("discord_token", accessToken);
            fetchDiscordUser(accessToken);
            window.history.replaceState({}, document.title, window.location.pathname);
          } else {
            setIsLoadingUser(false);
          }
        }
      }, []);

      const fetchDiscordUser = async (token) => {
        try {
          const response = await fetch("https://discord.com/api/users/@me", {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (response.ok) {
            setDiscordUser(await response.json());
          } else {
            localStorage.removeItem("discord_token");
          }
        } catch {
          localStorage.removeItem("discord_token");
        } finally {
          setIsLoadingUser(false);
        }
      };

      const handleDiscordLogin = () => {
        window.location.href =
          "https://discord.com/api/oauth2/authorize?client_id=1417511570124177418&response_type=token&redirect_uri=https%3A%2F%2F112-islas-baleares.vercel.app%2F&scope=identify";
      };

      const handleLogout = () => {
        localStorage.removeItem("discord_token");
        setDiscordUser(null);
      };

      /* NOTIFICACIONES */
      const showNotification = (message, type) => {
        setNotification({ show: true, message, type });
        setTimeout(() => setNotification({ show: false, message: "", type: "" }), 4000);
      };

      /* ENV√çO DEL FORMULARIO */
      const handleSubmit = async () => {
        if (!discordUser) {
          showNotification("Debe iniciar sesi√≥n", "error");
          return;
        }

        if (
          !formData.servicio ||
          !formData.incidente.trim() ||
          !formData.ciudadanoIC.trim() ||
          !formData.ubicacion.trim()
        ) {
          showNotification("Complete todos los campos obligatorios marcados con *", "error");
          return;
        }

        setIsSubmitting(true);

        try {
          const servicio = servicios.find((s) => s.value === formData.servicio);
          const prioridad = getPrioridad(formData.nivel);
          const timestamp = new Date();

          /* CAMPOS OPCIONALES */
          const safe = (v, def = "No indicado") => (v && v.trim() !== "" ? v : def);

          const embed = {
            author: {
              name: "üö® SISTEMA 112 MALLORCA",
              icon_url: "https://cdn-icons-png.flaticon.com/512/3588/3588592.png",
            },
            title: `${prioridad.icon} EMERGENCIA - PRIORIDAD ${prioridad.label}`,
            description:
              `**${servicio.emoji} ${servicio.value.toUpperCase()}**\n` +
              `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n` +
              `> Registro autom√°tico del sistema 112 Islas Baleares`,
            color: prioridad.colorHex,
            fields: [
              {
                name: "üìã DESCRIPCI√ìN DEL INCIDENTE",
                value: `\`\`\`\n${formData.incidente}\n\`\`\``,
              },
              {
                name: "üìÇ Tipo de incidente",
                value: `\`${safe(formData.tipoIncidente)}\``,
                inline: true,
              },
              {
                name: "üë• Personas implicadas",
                value: `\`${safe(formData.numeroPersonas)}\``,
                inline: true,
              },
              {
                name: "üß† Estado del ciudadano",
                value: `\`${safe(formData.estadoCiudadano)}\``,
              },
              {
                name: "üöó Veh√≠culo implicado",
                value: `\`${safe(formData.vehiculo)}\``,
              },

              /* IC */
              {
                name: "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ DATOS IC ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ",
                value: "\u200b",
              },
              {
                name: "üë§ Ciudadano (IC) *",
                value: `\`${formData.ciudadanoIC}\``,
                inline: true,
              },
              {
                name: "ü™™ Documento",
                value: `\`${safe(formData.documentoIC)}\``,
                inline: true,
              },
              {
                name: "üìû Tel√©fono (IC)",
                value: `\`${safe(formData.telefonoIC)}\``,
                inline: true,
              },
              {
                name: "üéÇ Edad (IC)",
                value: `\`${safe(formData.edadIC)}\``,
                inline: true,
              },
              {
                name: "ü©∏ Grupo sangu√≠neo",
                value: `\`${safe(formData.grupoSanguineo)}\``,
                inline: true,
              },
              {
                name: "‚öïÔ∏è Condiciones m√©dicas",
                value: `\`${safe(formData.condicionesMedicas)}\``,
              },
              {
                name: "üìç Ubicaci√≥n *",
                value: `\`${formData.ubicacion}\``,
              },

              /* OOC */
              {
                name: "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ DATOS OOC ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ",
                value: "\u200b",
              },
              {
                name: "üë§ Jugador (OOC)",
                value: `\`${safe(formData.ciudadanoOOC)}\``,
                inline: true,
              },
              {
                name: "üÜî Discord (OOC)",
                value: `\`${safe(formData.idDiscordOOC)}\``,
                inline: true,
              },
              {
                name: "üìù Notas OOC",
                value: `\`\`\`\n${safe(formData.notasOOC, "Sin notas")}\n\`\`\``,
              },

              /* OPERADOR */
              {
                name: "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ OPERADOR ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ",
                value: "\u200b",
              },
              {
                name: "üë®‚Äçüíº Responsable",
                value: `<@${discordUser.id}> ‚Ä¢ \`${discordUser.username}\``,
                inline: true,
              },
              {
                name: `${prioridad.icon} Prioridad`,
                value: `\`${prioridad.label} (Nivel ${formData.nivel}/20)\``,
                inline: true,
              },
              {
                name: "üìÖ Fecha",
                value: `\`${timestamp.toLocaleDateString("es-ES")}\``,
                inline: true,
              },
              {
                name: "‚è∞ Hora",
                value: `\`${timestamp.toLocaleTimeString("es-ES")}\``,
                inline: true,
              },
            ],
            thumbnail: {
              url: `https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png`,
            },
            footer: {
              text: "112 Mallorca ‚Ä¢ Sistema de Emergencias",
              icon_url: "https://cdn-icons-png.flaticon.com/512/3588/3588592.png",
            },
            timestamp: timestamp.toISOString(),
          };

          const roleMention = `<@&${servicio.roleId}>`;

          const response = await fetch(
            "https://discord.com/api/webhooks/1460348765671002195/daM84flVR5cQvYyXjxEeTvVSHFpXnz9R79m45EcDZj6yoZ5tgOTnmQRU_aHOWVX9VZ-x",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                content:
                  `${roleMention}\n\n` +
                  `üö® **NUEVA EMERGENCIA REGISTRADA**\n` +
                  `${prioridad.icon} **PRIORIDAD ${prioridad.label}** ¬∑ Nivel ${formData.nivel}/20\n` +
                  `${servicio.emoji} **Servicio asignado:** ${servicio.value}\n` +
                  `üë§ **Operador:** <@${discordUser.id}>`,
                username: "Central 112 Mallorca",
                avatar_url: "https://cdn-icons-png.flaticon.com/512/3588/3588592.png",
                embeds: [embed],
              }),
            }
          );

          if (!response.ok) throw new Error("Error al enviar");

          showNotification("‚úì Emergencia reportada correctamente", "success");

          /* RESET */
          setFormData({
            servicio: "",
            incidente: "",
            tipoIncidente: "",
            numeroPersonas: "",
            estadoCiudadano: "",
            vehiculo: "",
            ciudadanoIC: "",
            documentoIC: "",
            telefonoIC: "",
            edadIC: "",
            grupoSanguineo: "",
            condicionesMedicas: "",
            ubicacion: "",
            ciudadanoOOC: "",
            idDiscordOOC: "",
            notasOOC: "",
            nivel: 10,
          });
        } catch {
          showNotification("Error de conexi√≥n al enviar la emergencia", "error");
        } finally {
          setIsSubmitting(false);
        }
      };

      const prioridadActual = getPrioridad(formDat.nivel);
      if (isLoadingUser) {
        return (
          <div className="min-h-screen flex items-center justify-center bg-mallorca-bg">
            <div className="text-center">
              <div className="w-16 h-16 border-4 border-mallorca-accent/20 border-t-mallorca-accent rounded-full animate-spin mx-auto mb-4"></div>
              <p className="text-mallorca-text font-bold text-lg">Cargando sistema...</p>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-mallorca-bg">
          {/* Aqu√≠ empieza tu interfaz completa */}

          <main className="max-w-7xl mx-auto px-4 py-8">

            {!discordUser ? (
              <div className="max-w-lg mx-auto mt-20">
                <div className="bg-mallorca-card/90 backdrop-blur-xl rounded-xl shadow-xl border border-mallorca-accent2/20 p-12 text-center">
                  <div className="w-24 h-24 bg-mallorca-accent2 rounded-xl flex items-center justify-center mx-auto mb-8 shadow-xl border border-mallorca-accent">
                    <IconShield />
                  </div>
                  <h2 className="text-3xl font-black text-white mb-4">Acceso Seguro</h2>
                  <p className="text-mallorca-text2 text-sm mb-8">
                    Inicie sesi√≥n con Discord para acceder al panel de operador.
                  </p>
                  <button
                    onClick={handleDiscordLogin}
                    className="w-full bg-mallorca-accent2 hover:bg-mallorca-accent text-white font-bold py-4 rounded-lg flex items-center justify-center gap-3 shadow-lg transition-all"
                  >
                    <IconLogin />
                    <span className="text-lg">Iniciar Sesi√≥n con Discord</span>
                  </button>
                </div>
              </div>
            ) : (
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">

    
