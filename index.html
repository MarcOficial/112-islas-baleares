<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>112 Islas Baleares</title>
<link rel="icon" type="image/png" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSEA69X_qWWBU-3O3PcgrumqVEJoVA4dXWhIw&s" />
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const {useState,useEffect}=React;

const Phone=()=><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>;
const MapPin=()=><svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>;
const User=()=><svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
const Send=()=><svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>;
const LogIn=()=><svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>;
const Shield=()=><svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>;
const Clock=()=><svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>;

function Emergency112(){
  const [formData,setFormData]=useState({servicio:'',incidente:'',ciudadano:'',ubicacion:'',nivel:10});
  const [isSubmitting,setIsSubmitting]=useState(false);
  const [notification,setNotification]=useState({show:false,message:'',type:''});
  const [discordUser,setDiscordUser]=useState(null);
  const [isLoadingUser,setIsLoadingUser]=useState(true);
  const [currentTime,setCurrentTime]=useState(new Date());

  const servicios=[
    {value:'Polic√≠a Local',icon:'üëÆ‚Äç‚ôÄÔ∏è',emoji:'üöì',roleId:'ROLE_ID_POLICIA_LOCAL'},
    {value:'Polic√≠a Nacional',icon:'üëÆ‚Äç‚ôÇÔ∏è',emoji:'üöî',roleId:'1398228126919561216'},
    {value:'Guardia Civil',icon:'üõ°Ô∏è',emoji:'üö®',roleId:'ROLE_ID_GUARDIA_CIVIL'},
    {value:'SAMU 061',icon:'üöë',emoji:'üè•',roleId:'1398274968705568878'},
    {value:'Bomberos',icon:'üöí',emoji:'üî•',roleId:'1398274299151913061'},
    {value:'Conservaci√≥n',icon:'üß∞',emoji:'‚öôÔ∏è',roleId:'ROLE_ID_CONSERVACION'}
  ];

  const getPrioridad=(n)=>{
    if(n>=1&&n<=4) return {label:'MUY BAJA',icon:'üü¢',colorHex:0x10b981,bg:'from-green-500 to-green-700',text:'text-green-400'};
    if(n>=5&&n<=8) return {label:'BAJA',icon:'üíö',colorHex:0x22c55e,bg:'from-green-400 to-green-600',text:'text-green-300'};
    if(n>=9&&n<=12) return {label:'MEDIA',icon:'üü°',colorHex:0xfacc15,bg:'from-yellow-500 to-yellow-700',text:'text-yellow-400'};
    if(n>=13&&n<=16) return {label:'ALTA',icon:'üü†',colorHex:0xf97316,bg:'from-orange-500 to-orange-700',text:'text-orange-400'};
    if(n>=17&&n<=20) return {label:'CR√çTICA',icon:'üî¥',colorHex:0xef4444,bg:'from-red-500 to-red-700',text:'text-red-500'};
    return {label:'DESCONOCIDA',icon:'‚ùî',colorHex:0x6b7280,bg:'from-gray-400 to-gray-600',text:'text-gray-400'};
  };

  useEffect(()=>{const timer=setInterval(()=>setCurrentTime(new Date()),1000); return ()=>clearInterval(timer);},[]);

  useEffect(()=>{
    const token=localStorage.getItem('discord_token');
    if(token) fetchDiscordUser(token);
    else{
      const fragment=new URLSearchParams(window.location.hash.slice(1));
      const accessToken=fragment.get('access_token');
      if(accessToken){localStorage.setItem('discord_token',accessToken); fetchDiscordUser(accessToken); window.history.replaceState({},document.title,window.location.pathname);}
      else setIsLoadingUser(false);
    }
  },[]);

  const fetchDiscordUser=async(token)=>{
    try{
      const response=await fetch('https://discord.com/api/users/@me',{headers:{Authorization:`Bearer ${token}`}});
      if(response.ok) setDiscordUser(await response.json());
      else localStorage.removeItem('discord_token');
    }catch{localStorage.removeItem('discord_token');}finally{setIsLoadingUser(false);}
  };

  const handleDiscordLogin=()=>{window.location.href='https://discord.com/api/oauth2/authorize?client_id=1417511570124177418&response_type=token&redirect_uri=https%3A%2F%2F112-islas-baleares.vercel.app%2F&scope=identify';};
  const handleLogout=()=>{localStorage.removeItem('discord_token'); setDiscordUser(null);};

  const handleSubmit=async()=>{
    if(!discordUser){showNotification('Debe iniciar sesi√≥n','error');return;}
    if(!formData.servicio||!formData.incidente||!formData.ciudadano||!formData.ubicacion){showNotification('Complete todos los campos','error');return;}
    setIsSubmitting(true);
    try{
      const servicio=servicios.find(s=>s.value===formData.servicio);
      const prioridad=getPrioridad(formData.nivel);
      const timestamp=new Date();
      const embed={
        author:{name:"üö® SISTEMA 112 MALLORCA",icon_url:"https://cdn-icons-png.flaticon.com/512/3588/3588592.png"},
        title:`${prioridad.icon} EMERGENCIA - ${prioridad.label}`,
        description:`**${servicio.emoji} ${servicio.value}**\n\n\`\`\`${formData.incidente}\`\`\``,
        color:prioridad.colorHex,
        fields:[
          {name:`${prioridad.icon} PRIORIDAD`,value:`\`${prioridad.label} (Nivel ${formData.nivel}/20)\``,inline:true},
          {name:"üë§ CIUDADANO",value:`\`${formData.ciudadano}\``,inline:true},
          {name:"üìç UBICACI√ìN",value:`\`${formData.ubicacion}\``,inline:false},
          {name:"üë®‚Äçüíº OPERADOR",value:`<@${discordUser.id}>`,inline:true}
        ],
        thumbnail:{url:`https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png`},
        timestamp:timestamp.toISOString()
      };
      const roleMention=`<@&${servicio.roleId}>`;
      await fetch('https://discord.com/api/webhooks/1460348765671002195/daM84flVR5cQvYyXjxEeTvVSHFpXnz9R79m45EcDZj6yoZ5tgOTnmQRU_aHOWVX9VZ-x',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({content:`${roleMention}\n‚ö†Ô∏è **NUEVA EMERGENCIA** ‚ö†Ô∏è`,username:'Central 112 Mallorca',avatar_url:'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSEA69X_qWWBU-3O3PcgrumqVEJoVA4dXWhIw&s',embeds:[embed]})
      });
      showNotification('‚úì Emergencia reportada','success');
      setFormData({servicio:'',incidente:'',ciudadano:'',ubicacion:'',nivel:10});
    }catch{showNotification('Error de conexi√≥n','error');}
    finally{setIsSubmitting(false);}
  };

  const showNotification=(message,type)=>{setNotification({show:true,message,type}); setTimeout(()=>setNotification({show:false,message:'',type:''}),4000);};

  const prioridadActual=getPrioridad(formData.nivel);

  if(isLoadingUser){
    return(
      <div className="min-h-screen bg-gradient-to-tr from-indigo-900 via-purple-900 to-black flex items-center justify-center">
        <div className="text-center">
          <div className="w-20 h-20 border-4 border-purple-500/30 border-t-purple-500 rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-white font-bold text-lg">Cargando sistema...</p>
        </div>
      </div>
    );
  }

  return(
    <div className="min-h-screen bg-gradient-to-br from-indigo-950 via-black to-purple-950 text-white">
      <header className="bg-black/60 backdrop-blur-xl border-b border-purple-600/30 sticky top-0 z-50 shadow-lg">
        <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
          <div className="flex items-center gap-4">
            <div className="w-14 h-14 bg-purple-700 rounded-xl flex items-center justify-center shadow-lg animate-pulse"><Phone/></div>
            <div>
              <h1 className="text-2xl font-black text-white">112 Mallorca</h1>
              <p className="text-xs text-purple-300 font-semibold">Sistema de Emergencias</p>
            </div>
          </div>
          <div className="flex items-center gap-4">
            <div className="flex items-center gap-2 bg-white/10 px-3 py-2 rounded-xl">
              <Clock/>
              <span className="text-sm font-bold text-white">{currentTime.toLocaleTimeString('es-ES')}</span>
            </div>
            {discordUser?(
              <div className="flex items-center gap-3 bg-purple-800/30 px-4 py-2 rounded-xl border border-purple-500/40">
                <img src={`https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png`} className="w-9 h-9 rounded-full ring-2 ring-purple-400"/>
                <div className="hidden sm:block">
                  <p className="text-sm font-bold text-white">{discordUser.username}</p>
                  <p className="text-xs text-green-300">‚óè Activo</p>
                </div>
                <button onClick={handleLogout} className="text-xs text-purple-200 hover:text-red-400 font-bold">Salir</button>
              </div>
            ):(
              <button onClick={handleDiscordLogin} className="bg-gradient-to-r from-indigo-700 to-purple-700 hover:from-indigo-800 hover:to-purple-800 px-4 py-2 rounded-xl font-bold text-white flex items-center gap-2"><LogIn/>Iniciar Discord</button>
            )}
          </div>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
        {!discordUser?(
          <div className="lg:col-span-3 bg-gradient-to-br from-purple-900 to-indigo-900 rounded-3xl p-12 shadow-xl text-center">
            <div className="w-28 h-28 bg-gradient-to-br from-indigo-700 to-purple-700 rounded-3xl flex items-center justify-center mx-auto mb-8 shadow-lg">
              <Shield/>
            </div>
            <h2 className="text-4xl font-black mb-4">Acceso Seguro</h2>
            <p className="text-purple-300 text-lg mb-8">Autenticaci√≥n requerida</p>
            <button onClick={handleDiscordLogin} className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-5 rounded-2xl flex items-center justify-center gap-3 shadow-xl transform hover:scale-105 transition-all">
              <LogIn/>
              <span className="text-lg">Iniciar Sesi√≥n con Discord</span>
            </button>
          </div>
        ):(
          <>
          {/* Tarjeta Servicios */}
          <div className="lg:col-span-2 space-y-6">
            <div className="bg-gradient-to-br from-purple-900/80 to-indigo-900/80 backdrop-blur-xl rounded-xl p-6 shadow-lg border border-purple-600/30">
              <h3 className="text-xl font-black mb-5">Servicio de Emergencia</h3>
              <div className="grid grid-cols-3 gap-4">
                {servicios.map(s=>(
                  <button key={s.value} onClick={()=>setFormData({...formData,servicio:s.value})} className={`p-6 rounded-xl border-2 transition-all ${formData.servicio===s.value?'border-purple-500 bg-purple-500/30 shadow-lg scale-105':'border-purple-500/20 bg-black/30 hover:bg-purple-500/10'}`}>
                    <div className="text-5xl mb-2">{s.icon}</div>
                    <p className="font-bold text-white text-sm">{s.value}</p>
                  </button>
                ))}
              </div>
            </div>

            {/* Tarjeta Nivel */}
            <div className="bg-gradient-to-br from-purple-900/80 to-indigo-900/80 backdrop-blur-xl rounded-xl p-6 shadow-lg border border-purple-600/30">
              <h3 className="text-xl font-black mb-5">Nivel de Prioridad</h3>
              <div className="space-y-4">
                <div className="flex items-center gap-3">
                  <span className="text-4xl">{prioridadActual.icon}</span>
                  <div>
                    <p className={`text-2xl font-black ${prioridadActual.text}`}>{prioridadActual.label}</p>
                    <p className="text-sm text-purple-300">Nivel {formData.nivel}/20</p>
                  </div>
                </div>
                <input type="range" min="1" max="20" value={formData.nivel} onChange={(e)=>setFormData({...formData,nivel:parseInt(e.target.value)})} className="w-full h-4 rounded-full cursor-pointer" style={{background:'linear-gradient(to right,#10b981 0%,#10b981 25%,#facc15 25%,#facc15 50%,#f97316 50%,#f97316 80%,#ef4444 80%,#ef4444 100%)'}}/>
                <div className="flex justify-between text-xs text-purple-300 font-bold">
                  <span>1-4 Muy Baja üü¢</span>
                  <span>5-8 Baja üíö</span>
                  <span>9-12 Media üü°</span>
                  <span>13-16 Alta üü†</span>
                  <span>17-20 Cr√≠tica üî¥</span>
                </div>
              </div>
            </div>

            {/* Tarjeta Informaci√≥n del Incidente */}
            <div className="bg-gradient-to-br from-purple-900/80 to-indigo-900/80 backdrop-blur-xl rounded-xl p-6 shadow-lg border border-purple-600/30">
              <h3 className="text-xl font-black mb-5">Informaci√≥n del Incidente</h3>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-bold text-purple-300 mb-2">Descripci√≥n *</label>
                  <textarea value={formData.incidente} onChange={(e)=>setFormData({...formData,incidente:e.target.value})} placeholder="Describa la emergencia..." rows="3" className="w-full px-4 py-3 bg-black/30 border border-purple-600/30 rounded-xl text-white placeholder-purple-400 outline-none focus:ring-2 focus:ring-purple-500"/>
                </div>
                <div>
                  <label className="block text-sm font-bold text-purple-300 mb-2 flex items-center gap-2"><User/>Ciudadano (IC) *</label>
                  <input type="text" value={formData.ciudadano} onChange={(e)=>setFormData({...formData,ciudadano:e.target.value})} placeholder="Nombre del ciudadano" className="w-full px-4 py-3 bg-black/30 border border-purple-600/30 rounded-xl text-white placeholder-purple-400 outline-none focus:ring-2 focus:ring-purple-500"/>
                </div>
                <div>
                  <label className="block text-sm font-bold text-purple-300 mb-2 flex items-center gap-2"><MapPin/>Ubicaci√≥n *</label>
                  <input type="text" value={formData.ubicacion} onChange={(e)=>setFormData({...formData,ubicacion:e.target.value})} placeholder="Ubicaci√≥n exacta" className="w-full px-4 py-3 bg-black/30 border border-purple-600/30 rounded-xl text-white placeholder-purple-400 outline-none focus:ring-2 focus:ring-purple-500"/>
                </div>
              </div>
            </div>
          </div>

          {/* Tarjetas lateral */}
          <div className="space-y-6">
            <div className="bg-gradient-to-br from-purple-900/80 to-indigo-900/80 backdrop-blur-xl rounded-xl p-6 shadow-lg border border-purple-600/30">
              <h3 className="text-sm font-bold text-purple-300 mb-4 uppercase">Operador</h3>
              <div className="flex items-center gap-3">
                <img src={`https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png`} className="w-16 h-16 rounded-xl ring-2 ring-purple-400"/>
                <div>
                  <p className="font-bold text-white text-lg">{discordUser.username}</p>
                  <p className="text-xs text-green-400">‚úì Verificado</p>
                </div>
              </div>
            </div>

            <div className="bg-gradient-to-br from-purple-900/80 to-indigo-900/80 backdrop-blur-xl rounded-xl p-6 shadow-lg border border-purple-600/30">
              <h3 className="text-sm font-bold text-purple-300 mb-4 uppercase">Estado</h3>
              <div className="space-y-2 text-sm">
                <div className="flex justify-between"><span className="text-purple-300">Conexi√≥n</span><span className="text-green-400 font-bold">‚óè Activa</span></div>
                <div className="flex justify-between"><span className="text-purple-300">Webhook</span><span className="text-green-400 font-bold">‚óè Operativo</span></div>
              </div>
            </div>

            <button onClick={handleSubmit} disabled={isSubmitting} className="w-full bg-gradient-to-r from-purple-700 to-indigo-700 hover:from-purple-800 hover:to-indigo-800 disabled:from-gray-700 disabled:to-gray-800 text-white font-black py-5 rounded-xl flex items-center justify-center gap-3 shadow-xl transform hover:scale-105 transition-all">
              {isSubmitting?<div className="w-6 h-6 border-3 border-white border-t-transparent rounded-full animate-spin"></div>:<><Send/><span className="text-lg">REPORTAR EMERGENCIA</span></>}
            </button>
          </div>
          </>
        )}
      </main>

      {notification.show&&(
        <div className="fixed top-6 right-6 z-50">
          <div className={`${notification.type==='success'?'bg-green-600':'bg-red-600'} text-white px-6 py-4 rounded-xl shadow-xl font-bold`}>
            {notification.message}
          </div>
        </div>
      )}
    </div>
  );
}

ReactDOM.render(<Emergency112/>,document.getElementById('root'));
</script>
</body>
</html>
